FROM node:alpine as base
WORKDIR /home/node/app/frontend
COPY package.json yarn.lock ./
RUN yarn install
COPY . .

FROM node:current-alpine as builder
WORKDIR /builder
COPY . .
RUN yarn install
COPY --from=base /home/node/app/frontend/node_modules ./node_modules

ARG ARG_VITE_API_FRONTEND_BASE_URL \
    ARG_VITE_API_BACKEND_BASE_URL \
    ARG_VITE_GOOGLE_API_KEY \
    ARG_VITE_GOOGLE_ANALYTICS_KEY \
    ARG_VITE_FRONTEND_EXTERNAL_BASE_URL \
    ARG_VITE_BCC_EMAIL \
    ARG_VITE_STRIPE_PUBLIC_KEY \
    ARG_VITE_LIVECHAT_LICENSE \
    ARG_VITE_BILLING_DAYS_AFTER_CANCELING_SUBSCRIPTION \
    ARG_VITE_BILLING_PRICE_UNIT_AMOUNT_DECIMAL \
    ARG_VITE_BILLING_RECURRING_INTERVAL \
    ARG_VITE_BILLING_RECURRING_INTERVAL_COUNT \
    ARG_VITE_FINGERPRINT_PUBLIC_TOKEN \
    ARG_VITE_FINGERPRINT_SUBDOMAIN_URL \
    ARG_VITE_FINGERPRINT_COUNTRY_CODES \
    ARG_VITE_HELPDESK_LICENSE_ID \
    ARG_VITE_HELPDESK_CONTACT_FORM_ID

ENV VITE_API_FRONTEND_BASE_URL=$ARG_VITE_API_FRONTEND_BASE_URL \
    VITE_API_BACKEND_BASE_URL=$ARG_VITE_API_BACKEND_BASE_URL \
    VITE_GOOGLE_API_KEY=$ARG_VITE_GOOGLE_API_KEY \
    VITE_GOOGLE_ANALYTICS_KEY=$ARG_VITE_GOOGLE_ANALYTICS_KEY \
    VITE_FRONTEND_EXTERNAL_BASE_URL=$ARG_VITE_FRONTEND_EXTERNAL_BASE_URL \
    VITE_BCC_EMAIL=$ARG_VITE_BCC_EMAIL \
    VITE_STRIPE_PUBLIC_KEY=$ARG_VITE_STRIPE_PUBLIC_KEY \
    VITE_LIVECHAT_LICENSE=$ARG_VITE_LIVECHAT_LICENSE \ 
    VITE_BILLING_DAYS_AFTER_CANCELING_SUBSCRIPTION=$ARG_VITE_BILLING_DAYS_AFTER_CANCELING_SUBSCRIPTION \
    VITE_FINGERPRINT_SUBDOMAIN_URL=$ARG_VITE_FINGERPRINT_SUBDOMAIN_URL \
    VITE_FINGERPRINT_PUBLIC_TOKEN=$ARG_VITE_FINGERPRINT_PUBLIC_TOKEN \ 
    VITE_FINGERPRINT_COUNTRY_CODES=$ARG_VITE_FINGERPRINT_COUNTRY_CODES \
    VITE_HELPDESK_LICENSE_ID=$ARG_VITE_HELPDESK_LICENSE_ID \
    VITE_HELPDESK_CONTACT_FORM_ID=$ARG_VITE_HELPDESK_CONTACT_FORM_ID

ARG VITE_BILLING_PRICE_UNIT_AMOUNT_DECIMAL=$ARG_VITE_BILLING_PRICE_UNIT_AMOUNT_DECIMAL \
    VITE_BILLING_RECURRING_INTERVAL=$ARG_VITE_BILLING_RECURRING_INTERVAL \
    VITE_BILLING_RECURRING_INTERVAL_COUNT=$ARG_VITE_BILLING_RECURRING_INTERVAL_COUNT

RUN yarn build

FROM node:current-alpine as production
WORKDIR /mcr_frontend
ENV NODE_ENV production
RUN apk --no-cache add curl
ARG ARG_VITE_API_FRONTEND_BASE_URL \
    ARG_VITE_API_BACKEND_BASE_URL \
    ARG_VITE_GOOGLE_API_KEY \
    ARG_VITE_GOOGLE_ANALYTICS_KEY \
    ARG_VITE_FRONTEND_EXTERNAL_BASE_URL \
    ARG_VITE_BCC_EMAIL \
    ARG_VITE_STRIPE_PUBLIC_KEY \
    ARG_VITE_LIVECHAT_LICENSE \
    ARG_VITE_BILLING_DAYS_AFTER_CANCELING_SUBSCRIPTION \
    ARG_VITE_BILLING_PRICE_UNIT_AMOUNT_DECIMAL \
    ARG_VITE_BILLING_RECURRING_INTERVAL \
    ARG_VITE_BILLING_RECURRING_INTERVAL_COUNT \
    ARG_VITE_FINGERPRINT_PUBLIC_TOKEN \
    ARG_VITE_FINGERPRINT_SUBDOMAIN_URL \
    ARG_VITE_FINGERPRINT_COUNTRY_CODES \
    ARG_VITE_HELPDESK_LICENSE_ID \
    ARG_VITE_HELPDESK_CONTACT_FORM_ID
    

ENV VITE_API_FRONTEND_BASE_URL=$ARG_VITE_API_FRONTEND_BASE_URL \
    VITE_API_BACKEND_BASE_URL=$ARG_VITE_API_BACKEND_BASE_URL \
    VITE_GOOGLE_API_KEY=$ARG_VITE_GOOGLE_API_KEY \
    VITE_GOOGLE_ANALYTICS_KEY=$ARG_VITE_GOOGLE_ANALYTICS_KEY \
    VITE_FRONTEND_EXTERNAL_BASE_URL=$ARG_VITE_FRONTEND_EXTERNAL_BASE_URL \
    VITE_BCC_EMAIL=$ARG_VITE_BCC_EMAIL \
    VITE_STRIPE_PUBLIC_KEY=$ARG_VITE_STRIPE_PUBLIC_KEY \
    VITE_LIVECHAT_LICENSE=$ARG_VITE_LIVECHAT_LICENSE \ 
    VITE_BILLING_DAYS_AFTER_CANCELING_SUBSCRIPTION=$ARG_VITE_BILLING_DAYS_AFTER_CANCELING_SUBSCRIPTION \
    VITE_FINGERPRINT_SUBDOMAIN_URL=$ARG_VITE_FINGERPRINT_SUBDOMAIN_URL \
    VITE_FINGERPRINT_PUBLIC_TOKEN=$ARG_VITE_FINGERPRINT_PUBLIC_TOKEN \
    VITE_FINGERPRINT_COUNTRY_CODES=$ARG_VITE_FINGERPRINT_COUNTRY_CODES \
    VITE_HELPDESK_LICENSE_ID=$ARG_VITE_HELPDESK_LICENSE_ID \
    VITE_HELPDESK_CONTACT_FORM_ID=$ARG_VITE_HELPDESK_CONTACT_FORM_ID

ARG VITE_BILLING_PRICE_UNIT_AMOUNT_DECIMAL=$ARG_VITE_BILLING_PRICE_UNIT_AMOUNT_DECIMAL \
    VITE_BILLING_RECURRING_INTERVAL=$ARG_VITE_BILLING_RECURRING_INTERVAL \
    VITE_BILLING_RECURRING_INTERVAL_COUNT=$ARG_VITE_BILLING_RECURRING_INTERVAL_COUNT

COPY index.html index.html
COPY --from=builder /builder/dist ./dist
COPY --from=builder /builder/public ./public
COPY --from=builder /builder/node_modules ./node_modules
COPY --from=builder /builder/package.json ./package.json
COPY . .

CMD node ./dist/node-server/index.js
